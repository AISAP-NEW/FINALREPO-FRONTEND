<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/datasets"></ion-back-button>
    </ion-buttons>
    <ion-title>Dataset Details</ion-title>
    <ion-title class="ion-text-center">
      <div class="header-content">
        <ion-icon name="analytics" class="header-icon"></ion-icon>
        <span>Dataset Details</span>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="showDebugInfo = !showDebugInfo" fill="clear" class="debug-button">
        <ion-icon [name]="showDebugInfo ? 'bug' : 'bug-outline'" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Tab Navigation -->
  <ion-toolbar class="segment-toolbar">
    <ion-segment [value]="activeTab" (ionChange)="onSegmentChange($event)" mode="md" class="custom-segment">
      <ion-segment-button value="preview" class="segment-button">
        <ion-icon name="eye-outline" class="segment-icon"></ion-icon>
        <ion-label>Preview</ion-label>
      </ion-segment-button>
      <ion-segment-button value="schema" class="segment-button">
        <ion-icon name="grid-outline" class="segment-icon"></ion-icon>
        <ion-label>Schema</ion-label>
      </ion-segment-button>
      <ion-segment-button value="operations" class="segment-button">
        <ion-icon name="construct-outline" class="segment-icon"></ion-icon>
        <ion-label>Operations</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding content-background">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" class="loading-spinner"></ion-spinner>
    <p class="ion-text-center ion-margin-top">Loading dataset details...</p>
  </div>

  <!-- Preview Tab Content -->
  <div *ngIf="activeTab === 'preview' && !isLoading" class="tab-content">
    <ion-card class="metadata-card">
      <ion-card-header>
        <ion-card-title>{{ datasetInfo?.datasetName || 'No Dataset Name' }}</ion-card-title>
        <ion-card-subtitle>{{ datasetInfo?.description || 'No description available.' }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <p><strong>Created:</strong> {{ datasetInfo?.createdAt | date:'medium' }}</p>
        <p><strong>File Type:</strong> {{ datasetInfo?.fileType || 'Unknown' }}</p>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="datasetInfo">
      <img [src]="getThumbnailUrl(datasetInfo.DatasetId)" alt="Dataset Thumbnail" />
    </ion-card>

    <ion-card *ngIf="datasetInfo">
      <ion-card-header>
        <ion-card-title>{{ datasetInfo.DatasetName }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p><strong>Description:</strong> {{ datasetInfo.Description }}</p>
        <p><strong>File Type:</strong> {{ datasetInfo.FileType }}</p>
        <p><strong>Created:</strong> {{ datasetInfo.CreatedAt | date:'medium' }}</p>
      </ion-card-content>
    </ion-card>

    <!-- Dataset Preview Table -->
    <ion-card *ngIf="previewData.headers && previewData.headers.length > 0 && previewData.data && previewData.data.length > 0">
      <ion-card-header>
        <ion-card-title>Dataset Preview ({{ previewData.data.length }} rows)</ion-card-title>
      </ion-card-header>
      <ion-card-content class="table-scroll">
        <table class="preview-table">
          <thead>
            <tr>
              <th *ngFor="let header of previewData.headers">{{ header }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of previewData.data">
              <td *ngFor="let header of previewData.headers">{{ row[header] }}</td>
            </tr>
          </tbody>
        </table>
      </ion-card-content>
    </ion-card>

    <!-- Column Statistics -->
    <ion-card *ngIf="previewData.schema && previewData.schema.length > 0">
  <ion-card-header>
    <ion-card-title>Column Statistics</ion-card-title>
  </ion-card-header>
  <ion-card-content>
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="4" *ngFor="let col of previewData.schema">
          <ion-card color="light">
            <ion-card-header>
              <ion-card-subtitle>{{ col.name }}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <p>Type: {{ col.type }}</p>
              <div *ngIf="col.sampleValues && col.sampleValues.length > 0">
                <strong>Sample Values:</strong>
                <ion-chip *ngFor="let value of col.sampleValues.slice(0, 3)" class="sample-value">
                  {{ value }}
                </ion-chip>
                <ion-chip *ngIf="col.sampleValues.length > 3" color="medium">
                  +{{ col.sampleValues.length - 3 }} more
                </ion-chip>
              </div>
              <div *ngIf="!col.sampleValues || col.sampleValues.length === 0">
                <em>No sample values</em>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-card-content>
</ion-card>
  </div>

  <!-- Schema Tab Content -->
  <div *ngIf="activeTab === 'schema' && !isLoading">
    <ion-card *ngIf="previewData.schema && previewData.schema.length > 0">
      <ion-card-header>
        <ion-card-title>Dataset Schema</ion-card-title>
        <ion-card-subtitle>Structure and data types</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="full">
          <ion-item *ngFor="let field of previewData.schema">
            <ion-label>
              <h3>{{ field.name }}</h3>
              <p>
                <ion-badge [color]="field.nullable ? 'medium' : 'primary'">
                  {{ field.nullable ? 'Optional' : 'Required' }}
                </ion-badge>
                <ion-badge color="tertiary" class="ion-margin-start">
                  {{ field.type }}
                </ion-badge>
              </p>
            </ion-label>
            <ion-note slot="end" *ngIf="field.sampleValues" class="sample-values">
              <div class="sample-values">
                <ion-chip *ngFor="let value of field.sampleValues.slice(0, 3)" class="sample-value">
                  {{ value | truncate:15 }}
                </ion-chip>
                <ion-chip *ngIf="field.sampleValues.length > 3" color="medium">
                  +{{ field.sampleValues.length - 3 }} more
                </ion-chip>
              </div>
            </ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Operations Tab Content -->
  <div *ngIf="activeTab === 'operations' && !isLoading">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Dataset Operations</ion-card-title>
        <ion-card-subtitle>Validate, split, and export your dataset</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-accordion-group>
          <ion-accordion value="validation">
            <ion-item slot="header" color="light">
              <ion-icon name="checkmark-circle-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Data Validation</h3>
                <p>Check data quality and integrity</p>
              </ion-label>
            </ion-item>
            <div class="ion-padding" slot="content">
  <ion-button expand="block" color="primary" (click)="validateDataset()">
    Run Validation
  </ion-button>
  <div *ngIf="latestValidationResult" class="response-message validation-result">
    <ion-text [color]="latestValidationResult.Status === 'Failed' ? 'danger' : 'success'">
      <div *ngIf="latestValidationResult.Status === 'Failed'">
        <strong>Validation Failed:</strong> {{ latestValidationResult.ErrorCount }} errors at lines: {{ latestValidationResult.ErrorLines?.join(', ') || 'N/A' }}<br>
        <span>Total Rows: {{ latestValidationResult.TotalRows }}</span>
      </div>
      <div *ngIf="latestValidationResult.Status !== 'Failed'">
        <strong>Validation Succeeded!</strong>
      </div>
    </ion-text>
  </div>
  <div *ngIf="error && error.includes('Validation')" class="response-message error-message">
    <ion-text color="danger">{{ error }}</ion-text>
  </div>
</div>
          </ion-accordion>

          <ion-accordion value="split">
            <ion-item slot="header" color="light">
              <ion-icon name="git-branch-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Train/Test Split</h3>
                <p>Split your dataset into training and testing sets</p>
              </ion-label>
            </ion-item>
            <div class="ion-padding" slot="content">
  <ion-button expand="block" color="primary" (click)="splitDataset(selectedRatio.train, selectedRatio.test)">
    Split Dataset
  </ion-button>
  <div *ngIf="latestSplitResult" class="response-message split-result">
    <ion-text color="primary">
      <strong>Train/Test Split Complete!</strong><br>
      Train: {{ latestSplitResult.TrainCount }} ({{ latestSplitResult.TrainPercentage }}%)<br>
      Test: {{ latestSplitResult.TestCount }} ({{ latestSplitResult.TestPercentage }}%)
    </ion-text>
  </div>
  <div *ngIf="error && error.includes('Split')" class="response-message error-message">
    <ion-text color="danger">{{ error }}</ion-text>
  </div>
</div>
          </ion-accordion>

          <ion-accordion value="export">
            <ion-item slot="header" color="light">
              <ion-icon name="download-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Export Dataset</h3>
                <p>Download your dataset in different formats</p>
              </ion-label>
            </ion-item>
            <div class="ion-padding" slot="content">
              <ion-button expand="block" color="primary" (click)="downloadDataset('csv')">
                Download as CSV
              </ion-button>
              <ion-button expand="block" color="secondary" (click)="downloadDataset('json')">
                Download as JSON
              </ion-button>
            </div>
          </ion-accordion>
        </ion-accordion-group>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
