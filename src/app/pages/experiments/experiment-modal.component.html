<ion-modal [isOpen]="isOpen" (ionModalDidDismiss)="close()" cssClass="my-fullscreen-modal">
  <ion-header>
    <ion-toolbar>
      <ion-title>{{ mode === 'create' ? 'Add' : mode === 'edit' ? 'Edit' : 'View' }} Experiment</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="close()" class="close-button">
          <span aria-hidden="true">&times;</span>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  
  <ion-content class="ion-padding">
    <!-- Create/Edit Form -->
    <form #experimentForm="ngForm" (ngSubmit)="onSubmit(experimentForm)" *ngIf="mode === 'create' || mode === 'edit'">
      <ion-list>
        <!-- Name Field -->
        <ion-item [class.invalid-field]="hasMissingField('Name')">
          <ion-label position="stacked">
            Name <ion-text color="danger">*</ion-text>
            <ion-text color="medium" class="hint-text">Required, max 50 characters</ion-text>
          </ion-label>
          <ion-input 
            type="text" 
            [(ngModel)]="experiment.Name" 
            name="name" 
            required
            maxlength="50"
            aria-required="true"
            (ionInput)="updateFormValidity()"
            placeholder="Enter experiment name"
            [attr.aria-invalid]="hasMissingField('Name')">
          </ion-input>
          <ion-note slot="error" *ngIf="hasMissingField('Name')" color="danger">
            {{ getMissingFieldMessage('Name') }}
          </ion-note>
        </ion-item>
        
        <!-- Description Field -->
        <ion-item [class.invalid-field]="hasMissingField('Description')">
          <ion-label position="stacked">
            Description
            <ion-text color="medium" class="hint-text">Optional, describe your experiment</ion-text>
          </ion-label>
          <ion-textarea 
            [(ngModel)]="experiment.Description" 
            name="description" 
            [disabled]="mode === 'view'"
            rows="3"
            placeholder="Enter a brief description of your experiment"
            maxlength="500"
            autoGrow="true"
            (ionInput)="updateFormValidity()"
            [attr.aria-invalid]="hasMissingField('Description')">
          </ion-textarea>
          <ion-note slot="error" *ngIf="hasMissingField('Description')" color="danger">
            {{ getMissingFieldMessage('Description') }}
          </ion-note>
        </ion-item>
        
        <!-- Model File Upload -->
        <ion-item [class.invalid-field]="hasMissingField('ModelFile')" lines="none">
          <ion-label position="stacked">
            Model File <ion-text color="danger">*</ion-text>
            <ion-text color="medium" class="hint-text">
              Accepted formats: .py, .ipynb, .pkl, .h5, .pt, .pth, .onnx (max 100MB)
            </ion-text>
          </ion-label>
          
          <div class="file-upload-container">
            <!-- Custom styled file input button -->
            <ion-button 
              fill="outline" 
              (click)="fileInput.click()" 
              expand="block" 
              class="file-input-button"
              [attr.aria-label]="'Select model file' + (existingModelFile ? '. Current file: ' + existingModelFile.name : '')"
              [attr.aria-describedby]="'fileTypesHelp' + (modelFileError ? ' fileError' : '')"
              [color]="modelFileError ? 'danger' : 'medium'"
              [class.file-selected]="!!existingModelFile">
              <ion-icon name="cloud-upload" slot="start"></ion-icon>
              {{ existingModelFile ? 'Change File' : 'Choose File' }}
            </ion-button>
            
            <!-- Hidden file input -->
            <input 
              #fileInput
              type="file" 
              (change)="onModelFileChange($event); updateFormValidity()"
              id="modelFile"
              accept=".py,.ipynb,.pkl,.h5,.pt,.pth,.onnx"
              style="display: none;"
              aria-describedby="fileTypesHelp fileError"
              [attr.aria-invalid]="!!modelFileError">
            
            <!-- Selected file info -->
            <div *ngIf="existingModelFile" class="file-info">
              <ion-icon name="document" color="primary"></ion-icon>
              <div class="file-details">
                <div class="file-name">{{ existingModelFile.name }}</div>
                <div class="file-size" *ngIf="existingModelFile.size">
                  {{ formatFileSize(existingModelFile.size) }}
                </div>
              </div>
              <ion-button 
                fill="clear" 
                size="small" 
                color="danger" 
                (click)="clearFileInput($event)"
                aria-label="Remove file">
                <ion-icon name="close-circle" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
            
            <!-- Error message -->
            <ion-note *ngIf="modelFileError" color="danger" id="fileError">
              {{ modelFileError }}
            </ion-note>
          </div>
          
          <ion-note slot="error" *ngIf="hasMissingField('ModelFile')" color="danger">
            {{ getMissingFieldMessage('ModelFile') }}
          </ion-note>
        </ion-item>
        
        <!-- Status Field (Edit Mode Only) -->
        <ion-item *ngIf="mode === 'edit'" lines="none">
          <ion-label position="stacked">Status</ion-label>
          <ion-input 
            [(ngModel)]="experiment.Status" 
            name="status" 
            readonly
            [disabled]="true">
          </ion-input>
        </ion-item>
        
        <!-- Form-wide error messages -->
        <ion-item *ngIf="missingFields.length > 0" lines="none">
          <ion-text color="danger">
            <p>Please correct the following issues:</p>
            <ul>
              <li *ngFor="let field of missingFields">{{ field }}</li>
            </ul>
          </ion-text>
        </ion-item>
      </ion-list>
      
      <!-- Form Actions -->
      <ion-footer>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="close()" color="medium" fill="clear">
              <ion-icon name="close-circle" slot="start"></ion-icon>
              Cancel
            </ion-button>
          </ion-buttons>
          <ion-buttons slot="end">
            <ion-button 
              (click)="onSubmit(experimentForm)" 
              [disabled]="!checkFormValidity() || isSubmitting"
              [color]="checkFormValidity() ? 'primary' : 'medium'"
              [strong]="checkFormValidity()"
              fill="solid"
              class="save-button">
              <ion-icon name="save" slot="start" *ngIf="mode === 'edit'"></ion-icon>
              <ion-icon name="add-circle" slot="start" *ngIf="mode === 'create'"></ion-icon>
              {{ mode === 'create' ? 'Create Experiment' : 'Save Changes' }}
              <ion-spinner *ngIf="isSubmitting" name="dots" class="ion-margin-start"></ion-spinner>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-footer>
    </form>
    
    <!-- View Mode -->
    <div *ngIf="mode === 'view'" class="view-mode">
      <ion-list>
        <ion-item>
          <ion-label position="stacked" class="view-label">Name</ion-label>
          <ion-text class="view-value">{{ experiment.Name || 'N/A' }}</ion-text>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked" class="view-label">Description</ion-label>
          <ion-text class="view-value">{{ experiment.Description || 'No description provided' }}</ion-text>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked" class="view-label">Status</ion-label>
          <ion-badge [color]="getStatusColor(experiment.Status)" class="status-badge">
            {{ experiment.Status || 'N/A' }}
          </ion-badge>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked" class="view-label">Model File</ion-label>
          <div class="file-info" *ngIf="existingModelFile; else noFile">
            <ion-icon name="document" color="primary"></ion-icon>
            <div class="file-details">
              <div class="file-name">{{ existingModelFile.name }}</div>
              <div class="file-size" *ngIf="existingModelFile.size">
                {{ formatFileSize(existingModelFile.size) }}
              </div>
            </div>
          </div>
          <ng-template #noFile>
            <ion-text color="medium" class="view-value">No model file uploaded</ion-text>
          </ng-template>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked" class="view-label">Created</ion-label>
          <ion-text class="view-value">
            {{ experiment.CreatedAt ? (experiment.CreatedAt | date:'medium') : 'N/A' }}
          </ion-text>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked" class="view-label">Last Modified</ion-label>
          <ion-text class="view-value">
            {{ experiment.LastModified ? (experiment.LastModified | date:'medium') : 'N/A' }}
          </ion-text>
        </ion-item>
      </ion-list>
      
      <ion-footer>
        <ion-toolbar>
          <ion-buttons slot="end">
            <ion-button (click)="close()" color="primary" fill="solid" class="close-button">
              <ion-icon name="close" slot="start"></ion-icon>
              Close
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-footer>
    </div>
  </ion-content>
</ion-modal>

<style>
  .invalid-field {
    --border-color: var(--ion-color-danger);
    border-color: var(--ion-color-danger) !important;
  }
  .required {
    color: var(--ion-color-danger);
  }
</style> 