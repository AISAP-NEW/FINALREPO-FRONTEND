<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/models"></ion-back-button>
    </ion-buttons>
    <ion-title>Upload New Model</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <form [formGroup]="uploadForm" (ngSubmit)="onSubmit()">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Model Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">Model Name <ion-text color="danger">*</ion-text></ion-label>
          <ion-input 
            formControlName="modelName" 
            type="text" 
            placeholder="Enter model name"
            (ionInput)="uploadForm.get('modelName')?.markAsTouched()"
          ></ion-input>
          <ion-note slot="error" *ngIf="uploadForm.get('modelName')?.touched && uploadForm.get('modelName')?.errors?.['required']">
            Model name is required
          </ion-note>
          <ion-note slot="error" *ngIf="uploadForm.get('modelName')?.touched && uploadForm.get('modelName')?.errors?.['minlength']">
            Model name must be at least 3 characters
          </ion-note>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Description <ion-text color="danger">*</ion-text></ion-label>
          <ion-textarea 
            formControlName="description" 
            rows="3" 
            placeholder="Describe your model"
            (ionInput)="uploadForm.get('description')?.markAsTouched()"
          ></ion-textarea>
          <ion-note slot="error" *ngIf="uploadForm.get('description')?.touched && uploadForm.get('description')?.errors?.['required']">
            Description is required
          </ion-note>
          <ion-note slot="error" *ngIf="uploadForm.get('description')?.touched && uploadForm.get('description')?.errors?.['minlength']">
            Description must be at least 10 characters
          </ion-note>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Category <ion-text color="danger">*</ion-text></ion-label>
          <ion-select 
            formControlName="categoryId" 
            placeholder="Select category"
            [disabled]="isCategoriesLoading"
          >
            <ion-select-option *ngFor="let category of categories" [value]="category.Category_ID">
              {{ category.CategoryName }}
            </ion-select-option>
          </ion-select>
          <ion-spinner *ngIf="isCategoriesLoading" name="crescent"></ion-spinner>
          <ion-note slot="error" *ngIf="uploadForm.get('categoryId')?.touched && uploadForm.get('categoryId')?.errors?.['required']">
            Category is required
          </ion-note>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Topic <ion-text color="danger">*</ion-text></ion-label>
          <ion-select 
            formControlName="topicId" 
            placeholder="Select topic"
            [disabled]="isTopicsLoading || !uploadForm.get('categoryId')?.value"
          >
            <ion-select-option *ngFor="let topic of topics" [value]="topic.Topic_ID">
              {{ topic.TopicName }}
            </ion-select-option>
          </ion-select>
          <ion-spinner *ngIf="isTopicsLoading" name="crescent"></ion-spinner>
          <ion-note slot="error" *ngIf="uploadForm.get('topicId')?.touched && uploadForm.get('topicId')?.errors?.['required']">
            Topic is required
          </ion-note>
        </ion-item>

        <!-- Subtopic (optional) -->
        <ion-item>
          <ion-label position="stacked">Subtopic</ion-label>
          <ion-select 
            formControlName="subtopicId" 
            placeholder="Select subtopic"
            [disabled]="isSubtopicsLoading || !uploadForm.get('topicId')?.value"
          >
            <ion-select-option *ngFor="let sub of subtopics" [value]="sub.Subtopic_ID">
              {{ sub.SubtopicName }}
            </ion-select-option>
          </ion-select>
          <ion-spinner *ngIf="isSubtopicsLoading" name="crescent"></ion-spinner>
        </ion-item>

        <!-- Display selected topic description -->
        <ion-item *ngIf="selectedTopicDescription">
          <ion-label position="stacked">Topic Description</ion-label>
          <ion-text>{{ selectedTopicDescription }}</ion-text>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Model File</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div 
          class="drop-zone" 
          [class.dragging]="isDragging"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
          <input 
            #fileInput
            type="file" 
            style="display: none" 
            (change)="onFileSelected($event)"
            accept=".h5,.pb,.pt,.pth,.onnx,.pkl,.joblib,.model,.py,.js,.ts,.ipynb"
          >
          
          <ion-icon [name]="selectedFile ? 'cloud-upload-outline' : 'cloud-upload-outline'" size="large"></ion-icon>
          
          <div class="upload-text">
            <h3>{{ selectedFile ? 'File selected: ' + selectedFile.name : 'Drag & drop your model file here' }}</h3>
            <p>or click to browse files</p>
            <p class="file-types">Supported formats: .h5, .pb, .pt, .pth, .onnx, .pkl, .joblib, .model, .py, .js, .ts, .ipynb</p>
            <p class="file-types">Maximum file size: 500MB</p>
          </div>
          
          <ion-button *ngIf="selectedFile" fill="clear" color="danger" (click)="removeFile(); $event.stopPropagation()">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        
        <!-- Fallback file input for browsers that have issues with the main input -->
        <div class="ion-margin-top">
          <ion-button fill="outline" expand="block" (click)="fallbackFileInput.click()">
            <ion-icon name="folder-open-outline" slot="start"></ion-icon>
            Browse Files (Alternative)
          </ion-button>
          <input 
            #fallbackFileInput
            type="file" 
            style="display: none" 
            (change)="onFileSelected($event)"
            accept=".h5,.pb,.pt,.pth,.onnx,.pkl,.joblib,.model,.py,.js,.ts,.ipynb"
          >
        </div>
      </ion-card-content>
    </ion-card>

    <div class="ion-padding">
      <ion-button 
        expand="block" 
        type="submit" 
        [disabled]="uploadForm.invalid || !selectedFile || isLoading"
        class="ion-margin-top"
      >
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
        <span *ngIf="!isLoading">Upload Model</span>
      </ion-button>
    </div>
    
    <!-- Debug section (can be removed later) -->
    <div class="ion-padding" style="background: #f5f5f5; border-radius: 8px; margin-top: 16px;">
      <h4>Debug Info:</h4>
      <p><strong>Form Valid:</strong> {{ uploadForm.valid }}</p>
      <p><strong>Form Invalid:</strong> {{ uploadForm.invalid }}</p>
      <p><strong>File Selected:</strong> {{ selectedFile ? 'Yes' : 'No' }}</p>
      <p><strong>Is Loading:</strong> {{ isLoading }}</p>
      <p><strong>Button Disabled:</strong> {{ uploadForm.invalid || !selectedFile || isLoading }}</p>
      
              <h5>Field Details:</h5>
        <p><strong>Model Name:</strong> Value: "{{ uploadForm.get('modelName')?.value }}" | Valid: {{ uploadForm.get('modelName')?.valid }} | Touched: {{ uploadForm.get('modelName')?.touched }} | Errors: {{ uploadForm.get('modelName')?.errors | json }}</p>
        <p><strong>Description:</strong> Value: "{{ uploadForm.get('description')?.value }}" | Valid: {{ uploadForm.get('description')?.valid }} | Touched: {{ uploadForm.get('description')?.touched }} | Errors: {{ uploadForm.get('description')?.errors | json }}</p>
        <p><strong>Category:</strong> Value: "{{ uploadForm.get('categoryId')?.value }}" | Valid: {{ uploadForm.get('categoryId')?.valid }} | Touched: {{ uploadForm.get('categoryId')?.touched }} | Errors: {{ uploadForm.get('categoryId')?.errors | json }}</p>
        <p><strong>Topic:</strong> Value: "{{ uploadForm.get('topicId')?.value }}" | Valid: {{ uploadForm.get('topicId')?.valid }} | Touched: {{ uploadForm.get('topicId')?.touched }} | Errors: {{ uploadForm.get('topicId')?.errors | json }}</p>
      
      <h5>Form Values:</h5>
      <pre>{{ uploadForm.value | json }}</pre>
    </div>
  </form>
</ion-content>
